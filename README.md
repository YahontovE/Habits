# __трекер полезных привычек__
___
___
# О проекте 
> Удобное приложение для   приобретения новых полезных привычек и искоренению старых плохих привычек.
## ___Функции___
- _Пользователь создает свои полезные пирвычки_
- _Делится своими полезными привычками с пользователями приложения_
- _Отмечать, когда было бы удобно выполнять полызные привычки "время"_
- _Отмечать, сколько раз в неделю нужно выполянть привычку_
- _Отрпавлять сообщения в через телеграм бот в указанное время с указанной периодичностью_
___

## Сущности системы
  ### Привычка
  * пользователь
  * место выполнения
  * время выполнения
  * действие
  * связанная привычка (__опционально__)
  * признак приятной привычки
  * периодичность
  * вознаграждение
  * время на выполнение
  * признак публичности

### Пользователь
* имя пользователя
* пароль
* почта (__опционально__)
* telgram id (__опционально__)
* telegram username (__опционально__)

## Документация API
Документация для API реализована с помощью drf-yasg и находится на следующих эндпоинтах:
* http://127.0.0.1:8000/docs/
* http://127.0.0.1:8000/redoc/

## CORS
Для безопасности API реализован CORS с помощью django-cors-headers. 

В модуле ``settings.py`` необходимо внести изменения в следующие настройки, если у вас есть сторонние домены, обращающиеся к вашему API:

```
CORS_ALLOWED_ORIGINS = [
    "https://read-only.example.com",
    "https://read-and-write.example.com",
]

CSRF_TRUSTED_ORIGINS = [
    "https://read-and-write.example.com",
]
```

## Установка

1. Скачайте проект в домашнюю директорию.
2. Активируйте виртуальное окружение командой: poetry shell.
3. Установите зависимости командой: poetry install.

## Перед первым запуском программы:

1. Создайте Базу данных (в данной работе используется PostgreSQL) и перейдите в файл .env.sample и пропишите переменные
   окружения в формате(все данные после "=" в виде примера):

```ini
SECRET_KEY = 'django-secret-key'
DEBUG = True/False

DATABASE_NAME = 'name_of_db'
DATABASE_USER = 'db_user'
DATABASE_PASSWORD = 'your_password'
DATABASE_HOST = '127.0.0.1'
DATABASE_PORT = 5432

CELERY_BROKER_URL = 'smth://123.1.1.0:1234/0'
CELERY_RESULT_BACKEND = 'smth://123.1.1.0:1234/0'
CELERY_TIMEZONE = 'UTC'

TG_URL = 'https://api.telegram.org/bot'
TG_TOKEN = '123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11'
```

2. Выполните команды:
   - Для миграции в базу данных: `python manage.py migrate`
   - Для включения Redis(в терминале): `sudo service redis-server start`
   - Команда для запуска сервера: `python manage.py runserver`

***
## Работа кода

**Создание пользователя**
- Перед тем, как создать пользователя, создайте/войдите в аккаунт Telegram и перейдите по ссылке 
[Tg-бота](https://t.me/getmyid_bot). При выполнении команды `/start` вы получите User ID и Chat ID.
- Создание пользователя проходит через `post`-запрос в сервисе для обслуживания API(Например, [Postman](https://www.postman.com/)).
При создании пользователя в поле `chat_id` прописывается ID, полученный от [Tg-бота](https://t.me/getmyid_bot).
- После регистрации идет получение токена: через указания данных(Поля `username` и `password`) производится `post`-запрос.
При получении ответа, нужно скопировать значение ключа `access` и при дальнейшем пользовании в поле авторизации прописывать
`Bearer {token}` 


**Создание Tg-бота**
- Для создания Telegram-бота найдите в чате бота [BotFather](https://t.me/BotFather).
 Начните с ним диалог и выберите команду создания нового бота `/start`:


   - BotFather предложит ввести имя вашего бота:
   
   
   Здесь нужно указать видимое имя бота, т.е. то, которое отображается пользователям. Например, `ExampleBot`.
   
   - После этого BotFather спросит юзернейм вашего бота. Здесь бота нужно назвать уникально — это тот уникальный идентификатор, 
   - по которому бота можно будет найти. Также важно, чтобы имя заканчивалось на `_bot`. Например, `example_bot`.
   - Если имя подходит под все правила, BotFather предоставит токен и полезные ссылки для использования бота
   - Токен будет использован ботом для обращения к API Telegram-сервисов, поэтому его необходимо сразу сохранить в переменные окружения и не распространять.

***
**Возможные команды для управления привычками**

Все команды прописаны в документации по ссылке ` http://127.0.0.1:8000/api/schema/`

**Запуск отложенных задач**
  Для запуска отложенный задач(*отправка сообщения с привычкой*), нужно прописать команды:
* `celery -A config worker -l INFO` (для пользователей Windows OS нужно дописать `-P eventlet`)
* `celery -A config beat -l INFO`


## Для завершения работы

В терминале, где запущен сервер, worker и beat, прожать **Ctrl + C**
